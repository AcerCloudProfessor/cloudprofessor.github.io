<html>
<!--2016/12/26 Mark Yang - simple pixel editor for CPF web app -->

<title>CPF Pixel Editor</title>
<head>
    <link rel="stylesheet" href="css/main.css">
</head>

<body style="font-family:arial;width:800px">


<h1>CPF Pixel Editor</h1>

<div style="float:left">
    <div id='pe_area' style="float:left"></div>

    <div id='area' style="width:250px;float:left">
        <div id='cp_area'></div>
        <center>
        Click or tap to pick a color<br><br>
        </center>
        HEX: <input type="text" id="hex" size="6"></input>
        RGB: <input type="text" id="rgb" size="10"></input><br>
        <br>

    </div>
</div>
<p>
<p>
<div style="float:left">
Pixel Art Title:<br>
<textarea id="pixelart_title" rows="1" cols="90" style="font-family:arial;font-size:14px;">My_Pixel_Art</textarea><p>
Share Link:<br>
<textarea id="sharelink" rows="6" cols="90" style="font-family:arial;font-size:14px;" readonly>Click on pixels to generate link.</textarea>
</div>



<script>
//console.log(location.href);
//console.log(location.protocol);
//console.log(location.hostname);
//console.log(location);

// helper function
// from http://www.webdesignerdepot.com
function rgbToHex(R,G,B) {return toHex(R)+toHex(G)+toHex(B)}
function toHex(n) {
  n = parseInt(n,10);
  if (isNaN(n)) return "00";
  n = Math.max(0,Math.min(n,255));return "0123456789ABCDEF".charAt((n-n%16)/16) + "0123456789ABCDEF".charAt(n%16);
}


// PixelEditor class
var PixelEditor = function (options) {
    this.canv       = document.createElement("canvas");
    this.pixelsize  = Number(options.pixelsize);
    this.num_x      = Number(options.num_x);
    this.num_y      = Number(options.num_y);
    this.pp         = Number(options.pp);
    
    //canv = document.getElementById(options.id);
    var ps = + options.pixelsize;
    var cx = ps * options.num_x;
    var cy = ps * options.num_y;
 
    var canv = this.canv;
    canv.options = options;
    canv.options.cx = cx;
    canv.options.cy = cy;
    canv.PixelEditor= this;

    // canvas style
    canv.setAttribute("id", options.id);
    canv.setAttribute("class",  "pixel_editor");
    canv.setAttribute("width",  cx);
    canv.setAttribute("height", cy);
    canv.setAttribute("margin", 0);
    canv.setAttribute("padding",0);

    // add the canvas to the parent element
    var parentElem = document.getElementById(options.parent_id);
    parentElem.appendChild(canv);
    
    // pixel buffer
    this.pixelbytes = 3; // each pixel has 3-bytes for R, G, B
    this.pixeldata  = new Uint8ClampedArray (this.num_x * this.num_y * this.pixelbytes);

    // init pixel rects
    var r_init = 192;
    var g_init = 192;
    var b_init = 192;
    for (var i=0; i<this.num_x * this.num_y * this.pixelbytes; i+=3) {
        this.pixeldata[i  ] = r_init;
        this.pixeldata[i+1] = g_init;
        this.pixeldata[i+2] = b_init;
    }

    canv.pixelbytes = this.pixelbytes;
    canv.pixeldata  = this.pixeldata;

    // set color function
    this.setRGB = function (r, g, b) {
        var ctx = this.canv.getContext ('2d');
        ctx.fillStyle = "#" + rgbToHex (r, g, b);

        canv.curR = r;
        canv.curG = g;
        canv.curB = b;
        //alert (rgbhex_style);
    }

    // init color
    canv.curR = 200;
    canv.curG = 200;
    canv.curB = 200;
    this.setRGB (canv.curR, canv.curG, canv.curB);
    
    // draw pixel function
    this.FillPixel = function (x_idx, y_idx, r, g, b) {
        var pp = this.pp;
        var ps = this.pixelsize;

        var ctx = canv.getContext ('2d');
        var rect_x = x_idx * ps + pp;
        var rect_y = y_idx * ps + pp;
        
        ps = ps - pp * 2; // pixel size is reduced by paddings
        
        this.setRGB (r, g, b);
        ctx.fillRect (rect_x, rect_y, ps, ps);
    }

    // render function
    this.Render = function () {
        // draw grids
        var x, y;
        var ctx = this.canv.getContext ('2d');
        
        ctx.beginPath();
        for (y=0; y<=canv.height; y+=ps) {
            ctx.moveTo(0,y);
            ctx.lineTo(canv.width,y);
        }
        
        for (x=0; x<=canv.width; x+=ps) {
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canv.height);
        }
        
        ctx.stroke();

        // draw pixels
        var i=0, r, g, b;
        for (y=0; y<canv.options.num_y; y++) {
            for (x=0; x<canv.options.num_x; x++) {
                r = this.pixeldata[i++];
                g = this.pixeldata[i++];
                b = this.pixeldata[i++];

                this.FillPixel (x, y, r, g, b);
            }
        }
    }
    
    // pixel editor canvas click event handler
    var eventclick = function (event) {
        var x = event.pageX - this.offsetLeft;
        var y = event.pageY - this.offsetTop;
        
        if (x >= this.width ) x = this.width  - 1;
        if (y >= this.height) y = this.height - 1;
        
        var x_idx = Math.floor (x / ps);
        var y_idx = Math.floor (y / ps);

        var r = this.curR;
        var g = this.curG;
        var b = this.curB;
        this.PixelEditor.FillPixel (x_idx, y_idx, r, g, b);

        // record the pixel data
        var num_x = canv.options.num_x;
        var num_y = canv.options.num_y;

        var dataIdx = (y_idx * num_x + x_idx) * this.pixelbytes;

        this.pixeldata[dataIdx    ] = r;
        this.pixeldata[dataIdx + 1] = g;
        this.pixeldata[dataIdx + 2] = b;

        // generate sharelink
        var titleElem = document.getElementById(options.title_id);

        options.title = titleElem.value;
        options.pixelbytes = this.pixelbytes;
        options.num_x = num_x;
        options.num_y = num_y;
        options.pixeldata= this.pixeldata;
        options.sharelink_id = canv.options.sharelink_id;
        ComposeShareLink (options);
    }
    
    canv.addEventListener ('click', eventclick, false);
}

// setup color picker
var ColorPicker = function (options) {
    var img = new Image();
    img.onload = function () {
        this.cp_canv = document.createElement("canvas");
        this.cp_canv.setAttribute("id", options.id);
        this.cp_canv.setAttribute("class", "color_picker");

        this.cp_canv.setAttribute("width",  this.width);
        this.cp_canv.setAttribute("height", this.height);
        this.cp_canv.setAttribute("margin", 0);
        this.cp_canv.setAttribute("padding", 0);

        var ctx = this.cp_canv.getContext('2d');
        ctx.drawImage(img, 0, 0);

        document.getElementById(options.parent_id).appendChild(this.cp_canv);

        // click event handler
        this.cp_canv.addEventListener('click', function(event) {
            var x = event.pageX - this.offsetLeft;
            var y = event.pageY - this.offsetTop;

            console.log(ctx.getImageData(x, y, 1, 1));
            var imgData = ctx.getImageData(x, y, 1, 1).data;
            var R = imgData[0];
            var G = imgData[1];
            var B = imgData[2];

            console.log ("r: "+R+"  g: "+G+"  b:"+B);

            // show hex
            var rgbhex_box = document.getElementById ('hex');
            rgbhex_box.setAttribute ("value", rgbToHex(R,G,B));
            
            // show rgb
            var RGB = R + ',' + G + "," + B;
            var rgb_box = document.getElementById ('rgb');
            rgb_box.setAttribute ("value", RGB);

            pe.setRGB (R, G, B);

        }, false);

    }
    //img.crossOrigin="crossdomain.xml"; //$$$Mark Yang, this is to avoid "Cross-Origin data" exception
    img.src = options.image_src;
}

function ComposeShareLink (options) {
    var title = encodeURIComponent(options.title);
    var pixelbytes = options.pixelbytes;
    var num_x = options.num_x;
    var num_y = options.num_y;
    var pixeldata = options.pixeldata;
    var sharelink_id = options.sharelink_id;

    // compose the share link
    var link = location.protocol + "//" + location.hostname + location.pathname + "?";
    link = link + "title="+ title;
    link = link + "&nx=" + num_x;
    link = link + "&ny=" + num_y;

    // append pixel data
    console.log ("pixelbytes: " + pixelbytes);
    console.log ("total bytes: " + num_x*num_y*pixelbytes);
    link = link + "&pd=";
    for (var i=0; i<num_x*num_y*pixelbytes; i++) {

        link = link + toHex(pixeldata[i]);
    }

    console.log ("link: "+link);

    //var shareElemId = this.getAttribute ("sharelink_id");
    var shareElemId = sharelink_id;
    var shareElem   = document.getElementById(shareElemId);
    shareElem.value = link;
    console.log(shareElem);
}

var pe_options = {};
pe_options.parent_id = 'pe_area';
pe_options.id        = 'pixel_editor';
pe_options.pixelsize = '50';
pe_options.num_x     = '7';
pe_options.num_y     = '7';
pe_options.pp        = '3';
pe_options.title_id  = 'pixelart_title';
pe_options.sharelink_id = 'sharelink';

// parse URL parameters
if (location.search.length > 0) {
    var QueryVar = function (paramname)
    {
           var q = window.location.search.substring(1);
           var v = q.split("&");
           for (var i=0;i<v.length;i++) {
                   var pair = v[i].split("=");
                   //if(pair[0] == paramname){return pair[1];}
                   console.log (pair[0] + ":" + pair[1]);
           }
           return (false);
    }

    QueryVar (location.search);
}

var pe = new PixelEditor(pe_options);
//var pe = new PixelEditor({parent_id:'pe_area', id:"pixel_editor", pixelsize:'50', num_x:'7', num_y:'7', pp:'3', title_id: "pixelart_title", sharelink_id:"sharelink"});
pe.Render();

var cp = new ColorPicker({parent_id:'cp_area', id:"color_picker", image_src:"images/img_colormap.gif"});
</script>

</body>

</html>
